<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Suivi Production</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f4f4f4;
  padding:20px;
}
.box {
  background:white;
  padding:15px;
  border-radius:8px;
  max-width:520px;
  margin:15px auto;
}
input {
  width:95%;
  padding:12px;
  font-size:16px;
}
button {
  padding:8px 12px;
  margin-left:8px;
}
.step {
  margin:6px 0;
}
.ok { color:green; }
.todo { color:#888; }
.hidden { display:none; }
a { text-decoration:none; }
</style>
</head>

<body>

<h2>ğŸ“¦ Suivi de production</h2>

<div class="box">
  <input id="codeInput" placeholder="Scanner ou taper le code">
</div>

<div class="box hidden" id="projectBox">
  <h3 id="projectTitle"></h3>
  <p id="clientName"></p>

  <h4>ğŸ“‚ Dossier projet</h4>
  <div id="folderLink"></div>

  <h4>ğŸ“Œ Avancement</h4>
  <div id="steps"></div>
</div>

<div class="box">
  <div id="reader" style="width:100%;"></div>
</div>

<script>
// ================= CONFIG =================
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTSbYLrGQEm2zACNACmukjohMBGn3im1fS5SZD0jjCg6m7sd6iD3XIY22a6qRJcrDwHv-WqvLYwxCmR/pub?gid=0&single=true&output=tsv";
// =========================================

let rows = [];
let currentRow = null;

// ğŸ‘¤ prÃ©nom (1 seule fois)
let userName = localStorage.getItem("prenom");
if (!userName) {
  userName = prompt("Quel est ton prÃ©nom ?");
  localStorage.setItem("prenom", userName);
}

// ğŸ“¥ chargement CSV
fetch(CSV_URL + "&_=" + Date.now())
  .then(r => r.text())
  .then(text => {
    const lines = text.trim().split("\n");
    const sep = lines[0].includes(";") ? ";" : ",";
    rows = lines.slice(1).map(l =>
      l.split(sep).map(c => c.replace(/"/g,"").trim())
    );
  });

// ğŸ” recherche code
function searchCode(value) {
  if (!value) value = codeInput.value;
  const code = value.trim();
  const row = rows.find(r => r[0] === code);

  if (!row) {
    alert("âŒ Code inconnu");
    return;
  }

  currentRow = row;
  displayProject(row);
  codeInput.value = "";
}

// âŒ¨ï¸ zapette / clavier
codeInput.addEventListener("keydown", e => {
  if (e.key === "Enter") searchCode();
});

// ğŸ“„ affichage projet
function displayProject(r) {
  projectBox.classList.remove("hidden");

  projectTitle.textContent = r[2];
  clientName.textContent = "Client : " + r[1];

  folderLink.innerHTML = `
    <a href="${r[3]}" target="_blank">ğŸ“ Ouvrir le dossier Drive</a>
  `;

  const stepNames = [
    "RECEPTION FICHIER",
    "ATTENTE VALIDATION",
    "IMPRESSION",
    "ATELIER",
    "CONDITIONNEMENT",
    "POSE / LIVRAISON"
  ];

  steps.innerHTML = "";
  stepNames.forEach((name, i) => {
    const val = r[4+i];
    const done = val && val.includes("âœ…");
    steps.innerHTML += `
      <div class="step ${done ? "ok":"todo"}">
        ${name} : ${val || "â³"}
        <button onclick="validateStep(${i})">Valider</button>
      </div>
    `;
  });
}

// âœ… validation (locale V1)
function validateStep(index) {
  const now = new Date().toLocaleString();
  currentRow[4+index] = `âœ… ${userName} â€“ ${now}`;
  displayProject(currentRow);
  alert("Ã‰tape validÃ©e (CSV en lecture seule pour lâ€™instant)");
}

// ğŸ“· camÃ©ra (1D + QR)
const html5QrCode = new Html5Qrcode("reader");
html5QrCode.start(
  { facingMode:"environment" },
  {
    fps: 6,
    qrbox: { width: 320, height: 160 },
    formatsToSupport: [
      Html5QrcodeSupportedFormats.CODE_128,
      Html5QrcodeSupportedFormats.EAN_13,
      Html5QrcodeSupportedFormats.QR_CODE
    ]
  },
  decodedText => searchCode(decodedText)
);
</script>

</body>
</html>
