<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Suivi production</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body { font-family: Arial, sans-serif; background:#f7f7f7; padding:20px; }
h2 { margin-bottom:5px; }
.box { background:#fff; border-radius:8px; padding:15px; margin:15px auto; max-width:500px; }
button { padding:10px 15px; margin:5px; font-size:15px; }
input { padding:10px; font-size:16px; width:90%; }
.step { margin:6px 0; }
.ok { color:green; }
.todo { color:#999; }
.folder a { text-decoration:none; }
.hidden { display:none; }
</style>
</head>

<body>

<h2>ğŸ“¦ Suivi de production</h2>

<div class="box">
  <input id="codeInput" placeholder="Scannez le code-barres">
</div>

<div class="box hidden" id="projectBox">
  <h3 id="title"></h3>
  <p id="client"></p>
  <img id="image" style="max-width:200px"><br>

  <h4>ğŸ“‚ Dossier projet</h4>
  <div id="folders"></div>

  <h4>ğŸ“Œ Avancement</h4>
  <div id="steps"></div>
</div>

<div class="box hidden" id="readerBox">
  <div id="reader" style="width:320px;margin:auto;"></div>
</div>

<script>
// ğŸ”— LIEN CSV PUBLIÃ‰
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTSbYLrGQEm2zACNACmukjohMBGn3im1fS5SZD0jjCg6m7sd6iD3XIY22a6qRJcrDwHv-WqvLYwxCmR/pub?gid=0&single=true&output=csv";

let data = [];
let currentRow = null;

// ğŸ‘¤ PrÃ©nom (1 seule fois)
let userName = localStorage.getItem("prenom");
if (!userName) {
  userName = prompt("Quel est ton prÃ©nom ?");
  localStorage.setItem("prenom", userName);
}

// ğŸ“¥ Chargement CSV
fetch(csvUrl).then(r => r.text()).then(text => {
  const lines = text.trim().split("\n");
  const sep = lines[0].includes(";") ? ";" : ",";
  data = lines.slice(1).map(l => l.split(sep).map(c => c.trim()));
});

// ğŸ” Recherche code
function searchCode(code) {
  if (!code) code = codeInput.value.trim();
  const row = data.find(r => r[0] === code);
  if (!row) return alert("Code inconnu");
  currentRow = row;
  displayProject(row);
  codeInput.value = "";
}

// ğŸ–¥ï¸ Zapette
codeInput.addEventListener("keydown", e => {
  if (e.key === "Enter") searchCode();
});

// ğŸ“„ Affichage projet
function displayProject(r) {
  projectBox.classList.remove("hidden");

  title.textContent = r[2];
  client.textContent = "Client : " + r[1];
  image.src = r[10];

  // ğŸ“‚ Arborescence
  folders.innerHTML = `
    <div class="folder"><a href="${r[3]}" target="_blank">ğŸ“ Ouvrir dossier projet</a></div>
  `;

  // ğŸ“Œ Ã‰tapes
  const stepsNames = [
    "RECEPTION_FICHIER",
    "ATTENTE_VALIDATION",
    "IMPRESSION",
    "ATELIER",
    "CONDITIONNEMENT",
    "POSE_LIVRAISON"
  ];

  steps.innerHTML = "";
  stepsNames.forEach((name, i) => {
    const value = r[4+i];
    const done = value && value.includes("âœ…");
    steps.innerHTML += `
      <div class="step ${done ? "ok":"todo"}">
        ${name.replace("_"," ")} :
        ${value || "â³"}
        <button onclick="validateStep(${i})">Valider</button>
      </div>
    `;
  });
}

// âœ… Validation Ã©tape
function validateStep(index) {
  const now = new Date().toLocaleString();
  currentRow[4+index] = `âœ… ${userName} â€“ ${now}`;
  displayProject(currentRow);
  alert("Ã‰tape validÃ©e (mise Ã  jour visible aprÃ¨s rafraÃ®chissement CSV)");
}

// ğŸ“· CamÃ©ra (mobile)
if (/iPhone|Android/i.test(navigator.userAgent)) {
  readerBox.classList.remove("hidden");
  new Html5Qrcode("reader").start(
    { facingMode:"environment" },
    {
      fps:5,
      qrbox:{ width:320, height:120 },
      formatsToSupport:[
        Html5QrcodeSupportedFormats.CODE_128,
        Html5QrcodeSupportedFormats.EAN_13
      ]
    },
    searchCode
  );
}
</script>

</body>
</html>
