<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Scanner documents</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  padding: 20px;
}

.box {
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 15px;
  margin: 15px auto;
  max-width: 420px;
}

input {
  font-size: 18px;
  padding: 10px;
  width: 90%;
}

button {
  font-size: 16px;
  padding: 8px 16px;
  margin-top: 10px;
  cursor: pointer;
}

#reader {
  margin: auto;
}

img {
  max-width: 200px;
  margin-top: 10px;
}

#result {
  margin-top: 20px;
}
</style>
</head>

<body>

<h2>üìÇ Consultation documents</h2>

<!-- MODE ZAPETTE / MAC -->
<div class="box">
  <h3>‚å®Ô∏è Scan zapette (Mac / PC)</h3>
  <input id="codeInput" placeholder="Scannez le code-barres ici">
  <br>
  <button onclick="searchCode()">Valider</button>
</div>

<!-- MODE CAMERA / IPHONE -->
<div class="box">
  <h3>üì∑ Scan cam√©ra (iPhone)</h3>
  <div id="reader" style="width:320px;"></div>
</div>

<div id="result"></div>

<script>
// üîó LIEN CSV PUBLI√â (OBLIGATOIRE)
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTSbYLrGQEm2zACNACmukjohMBGn3im1fS5SZD0jjCg6m7sd6iD3XIY22a6qRJcrDwHv-WqvLYwxCmR/pub?gid=0&single=true&output=csv";

let data = [];

/* =======================
   CHARGEMENT DU CSV
======================= */
fetch(csvUrl)
  .then(r => r.text())
  .then(text => {
    const lines = text.trim().split("\n");

    // D√©tection automatique du s√©parateur
    const separator = lines[0].includes(";") ? ";" : ",";

    data = lines.slice(1).map(line =>
      line.split(separator).map(cell => cell.trim())
    );

    console.log("CSV charg√© :", data);
  });

/* =======================
   AFFICHAGE DU R√âSULTAT
======================= */
function displayResult(row) {
  document.getElementById("result").innerHTML = `
    <h3>${row[1]}</h3>
    <p><b>Dossier :</b> ${row[2]}</p>
    <p><b>Statut :</b> ${row[3]}</p>
    <img src="${row[5]}" alt="">
    <br><br>
    <a href="${row[4]}" target="_blank">
      <button>üìÇ Ouvrir</button>
    </a>
  `;
}

/* =======================
   RECHERCHE DU CODE
======================= */
function searchCode(code) {
  if (!code) code = document.getElementById("codeInput").value;
  code = code.trim();

  console.log("Code scann√© :", code);

  const row = data.find(r => r[0] === code);

  if (!row) {
    document.getElementById("result").innerHTML =
      "‚ùå Code inconnu : " + code;
    return;
  }

  displayResult(row);
  document.getElementById("codeInput").value = "";
  document.getElementById("codeInput").focus();
}

/* =======================
   ZAPETTE = ENTR√âE AUTO
======================= */
document.getElementById("codeInput").addEventListener("keydown", e => {
  if (e.key === "Enter") searchCode();
});

/* =======================
   CAMERA IPHONE
   R√âGLAGES IMPORTANTS
======================= */
if (/iPhone|Android/i.test(navigator.userAgent)) {

  new Html5Qrcode("reader").start(
    { facingMode: "environment" },

    {
      // üîÑ TAUX DE RAFRA√éCHISSEMENT
      fps: 5,               // plus bas = plus fiable en 1D

      // üìê TAILLE ZONE SCAN (CODE-BARRES 1D)
      qrbox: {
        width: 320,         // largeur importante
        height: 120         // faible hauteur = 1D
      },

      // üìä TYPES DE CODES AUTORIS√âS
      formatsToSupport: [
        Html5QrcodeSupportedFormats.CODE_128,
        Html5QrcodeSupportedFormats.EAN_13,
        Html5QrcodeSupportedFormats.EAN_8
      ]
    },

    searchCode
  );
}
</script>

</body>
</html>
