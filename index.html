<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Suivi Production</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body { font-family: Arial; background:#f4f4f4; padding:20px; }
.box { background:#fff; padding:15px; border-radius:8px; max-width:520px; margin:15px auto; }
input { width:95%; padding:12px; font-size:16px; }
.step { margin:6px 0; }
.ok { color:green; }
.todo { color:#888; }
.hidden { display:none; }
</style>
</head>

<body>

<h2>ğŸ“¦ Suivi production</h2>

<div class="box">
  <input id="codeInput" placeholder="Scanner ou taper le code">
</div>

<div class="box hidden" id="projectBox">
  <h3 id="projectTitle"></h3>
  <p id="clientName"></p>

  <a id="folderLink" target="_blank">ğŸ“ Ouvrir dossier projet</a>

  <h4>ğŸ“Œ Avancement</h4>
  <div id="steps"></div>
</div>

<div class="box">
  <div id="reader"></div>
</div>

<script>
// ================= CONFIG =================
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTSbYLrGQEm2zACNACmukjohMBGn3im1fS5SZD0jjCg6m7sd6iD3XIY22a6qRJcrDwHv-WqvLYwxCmR/pub?gid=0&single=true&output=csv";
// =========================================

let rows = [];

// ğŸ”§ fonction NETTOYAGE (clÃ© du problÃ¨me)
function clean(text) {
  return text
    .toString()
    .replace(/"/g,"")
    .replace(/\s+/g,"")
    .toUpperCase();
}

// ğŸ‘¤ prÃ©nom (1 fois)
let user = localStorage.getItem("prenom");
if (!user) {
  user = prompt("Ton prÃ©nom ?");
  localStorage.setItem("prenom", user);
}

// ğŸ“¥ chargement CSV
fetch(CSV_URL + "&_=" + Date.now())
  .then(r => r.text())
  .then(text => {
    const sep = text.includes(";") ? ";" : ",";
    rows = text.trim().split("\n").slice(1).map(l =>
      l.split(sep).map(c => c.trim())
    );
    console.log("CSV chargÃ© :", rows.length, "lignes");
  });

// ğŸ” recherche code
function searchCode(value) {
  const scanned = clean(value || codeInput.value);
  console.log("Code scannÃ© :", scanned);

  const row = rows.find(r => clean(r[0]) === scanned);

  if (!row) {
    alert("âŒ Code inconnu");
    return;
  }

  display(row);
  codeInput.value = "";
}

// âŒ¨ï¸ zapette
codeInput.addEventListener("keydown", e => {
  if (e.key === "Enter") searchCode();
});

// ğŸ“„ affichage
function display(r) {
  projectBox.classList.remove("hidden");
  projectTitle.textContent = r[2];
  clientName.textContent = "Client : " + r[1];
  folderLink.href = r[3];

  const stepsNames = [
    "RECEPTION FICHIER",
    "ATTENTE VALIDATION",
    "IMPRESSION",
    "ATELIER",
    "CONDITIONNEMENT",
    "POSE / LIVRAISON"
  ];

  steps.innerHTML = "";
  stepsNames.forEach((n,i)=>{
    const v = r[4+i];
    steps.innerHTML += `
      <div class="step ${v ? "ok":"todo"}">
        ${n} : ${v || "â³"}
      </div>`;
  });
}

// ğŸ“· camÃ©ra (1D + QR)
new Html5Qrcode("reader").start(
  { facingMode:"environment" },
  {
    fps:6,
    qrbox:{ width:320, height:160 },
    formatsToSupport:[
      Html5QrcodeSupportedFormats.CODE_128,
      Html5QrcodeSupportedFormats.EAN_13,
      Html5QrcodeSupportedFormats.QR_CODE
    ]
  },
  text => searchCode(text)
);
</script>

</body>
</html>
