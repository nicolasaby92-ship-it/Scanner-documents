<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Suivi Production</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f4f4f4;
  padding:20px;
}
.box {
  background:#fff;
  padding:15px;
  border-radius:8px;
  max-width:520px;
  margin:15px auto;
}
input {
  width:95%;
  padding:12px;
  font-size:16px;
}
.step {
  margin:6px 0;
}
.ok { color:green; }
.todo { color:#888; }
.hidden { display:none; }
a { text-decoration:none; display:block; margin:6px 0; }
</style>
</head>

<body>

<h2>ğŸ“¦ Suivi de production</h2>

<div class="box">
  <input id="codeInput" placeholder="Scanner ou taper le code">
</div>

<div class="box hidden" id="projectBox">
  <h3 id="projectTitle"></h3>
  <p id="clientName"></p>

  <!-- IMAGE PREVIEW -->
  <img id="previewImage"
       style="max-width:100%;margin-top:10px;border-radius:6px;
              cursor:pointer;display:none;">

  <a id="folderLink" target="_blank">ğŸ“ Ouvrir le dossier Drive</a>

  <h4>ğŸ“Œ Avancement</h4>
  <div id="steps"></div>
</div>

<div class="box">
  <div id="reader"></div>
</div>

<!-- IMAGE PLEIN Ã‰CRAN -->
<div id="imageModal"
     style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
            background:rgba(0,0,0,0.9);z-index:9999;"
     onclick="closeImage()">
  <img id="modalImage"
       style="max-width:95%;max-height:95%;margin:auto;display:block;
              position:absolute;top:0;bottom:0;left:0;right:0;">
</div>

<script>
// ================= CONFIG =================
const CSV_URL = "https://script.google.com/macros/s/AKfycbxzxQgrk7k6hd_IUlLn4Digg6bjb4HzEF1jkXS98OQCArjw8Y-1aD1glKdjxiz4WFPk/exec";
// =========================================

let rows = [];
let currentRow = null;

// ğŸ”§ Nettoyage code (IMPORTANT)
function clean(value) {
  return String(value)
    .replace(/"/g,"")
    .replace(/\s+/g,"")
    .trim();
}

// ğŸ‘¤ PrÃ©nom (1 seule fois)
let user = localStorage.getItem("prenom");
if (!user) {
  user = prompt("Quel est ton prÃ©nom ?");
  localStorage.setItem("prenom", user);
}

// ğŸ“¥ Chargement CSV
fetch(CSV_URL + "&_=" + Date.now())
  .then(r => r.text())
  .then(text => {
    const sep = text.includes(";") ? ";" : ",";
    rows = text.trim().split("\n").slice(1).map(l =>
      l.split(sep).map(c => c.trim())
    );
  });

// ğŸ” Recherche code
function searchCode(value) {
  const scanned = clean(value || codeInput.value);
  const row = rows.find(r => clean(r[0]) === scanned);

  if (!row) {
    alert("âŒ Code inconnu");
    return;
  }

  currentRow = row;
  display(row);
  codeInput.value = "";
}

// âŒ¨ï¸ Zapette / clavier
codeInput.addEventListener("keydown", e => {
  if (e.key === "Enter") searchCode();
});

// ğŸ“„ Affichage projet
function display(r) {
  projectBox.classList.remove("hidden");

  projectTitle.textContent = r[2];
  clientName.textContent = "Client : " + r[1];
  folderLink.href = r[3];

  // ğŸ–¼ï¸ Image
  const img = document.getElementById("previewImage");
  if (r[10]) {
    img.src = r[10];
    img.style.display = "block";
    img.onclick = () => openImage(r[10]);
  } else {
    img.style.display = "none";
  }

  const stepsNames = [
    "INTITULE",
    "DIMENSSION",
    "SUPPORT",
    "QUANTITES",
    "FINITION",
    "POSE / LIVRAISON"
  ];

  steps.innerHTML = "";
  stepsNames.forEach((n,i)=>{
    const v = r[4+i];
    steps.innerHTML += `
      <div class="step ${v ? "ok":"todo"}">
        ${n} : ${v || "â³"}
      </div>`;
  });
}

// ğŸ–¼ï¸ Plein Ã©cran image
function openImage(src) {
  modalImage.src = src;
  imageModal.style.display = "block";
}
function closeImage() {
  imageModal.style.display = "none";
}

// ğŸ“· CamÃ©ra (1D + QR)
new Html5Qrcode("reader").start(
  { facingMode:"environment" },
  {
    fps:6,
    qrbox:{ width:320, height:160 },
    formatsToSupport:[
      Html5QrcodeSupportedFormats.CODE_128,
      Html5QrcodeSupportedFormats.EAN_13,
      Html5QrcodeSupportedFormats.QR_CODE
    ]
  },
  text => searchCode(text)
);
</script>

</body>
</html>
