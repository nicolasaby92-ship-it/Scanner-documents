<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Gestion Projets & Stock</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body { font-family: Inter, Arial, sans-serif; background:#f5f6f8; margin:0; }
header { background:#111; color:#fff; padding:15px; text-align:center; }
main { padding:20px; max-width:1100px; margin:auto; }

.box {
  background:#fff; padding:15px; margin-bottom:20px;
  border-radius:10px; box-shadow:0 5px 20px rgba(0,0,0,.08);
}

input, button, select {
  padding:10px; font-size:16px; border-radius:6px;
  border:1px solid #ccc; margin:5px 0;
}

button {
  background:#111; color:#fff; border:none; cursor:pointer;
}
button.secondary { background:#666; }

table {
  width:100%; border-collapse:collapse; margin-top:10px;
}
th, td {
  padding:8px; border-bottom:1px solid #ddd; text-align:left;
}
th { background:#eee; }

.toggle {
  cursor:pointer;
}
</style>
</head>

<body>

<header>
<h2>üì¶ Suivi Projets & Stock</h2>
</header>

<main>

<!-- SCAN -->
<div class="box">
<h3>üì∑ Scan QR / Code-barres</h3>
<div id="reader" style="width:300px"></div>

<input id="manualCode" placeholder="Entrer / scanner un code">
<button onclick="manualScan()">Valider</button>
</div>

<!-- FICHE -->
<div class="box" id="detailBox" style="display:none">
<h3>üìÑ Fiche √©l√©ment</h3>
<div id="detail"></div>
<button class="secondary" onclick="loadProject()">üìÇ Voir le projet complet</button>
</div>

<!-- PROJET -->
<div class="box" id="projectBox" style="display:none">
<h3>üìÅ Projet complet</h3>
<table id="projectTable"></table>
</div>

<!-- STOCK -->
<div class="box">
<h3>üì¶ Stock</h3>
<table id="stockTable"></table>
</div>

</main>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxwx_UfBanfImck0ZFPvyV8fqvJiIs4Lq_QEoeNGplRd-wjuGVdmncpLxm93A9uB8LBiA/exec";

let allProjects = [];

// ========================
// SCAN CAMERA
// ========================
new Html5Qrcode("reader").start(
  { facingMode: "environment" },
  { fps: 5, qrbox: 250 },
  code => handleScan(code)
);

// ========================
// MANUEL
// ========================
function manualScan() {
  const code = document.getElementById("manualCode").value.trim();
  if (code) handleScan(code);
}

// ========================
// TRAITEMENT SCAN
// ========================
function handleScan(code) {
  fetch(API_URL + "?action=list")
    .then(r => r.json())
    .then(data => {
      allProjects = data;
      const item = data.find(d => d.id == code);
      if (!item) {
        alert("Code inconnu");
        return;
      }
      showDetail(item);
      logScan(code);
    });
}

// ========================
// FICHE
// ========================
function showDetail(d) {
  document.getElementById("detailBox").style.display = "block";
  document.getElementById("detail").innerHTML = `
    <b>Client :</b> ${d.client}<br>
    <b>Projet :</b> ${d.projet}<br>
    <b>Type :</b> ${d.type}<br>
    <b>Intitul√© :</b> ${d.intitule}<br>
    <b>Quantit√© :</b> ${d.quantite}<br>
    <label>
      <input type="checkbox" ${d.imprime ? "checked" : ""}
        onchange="updateStatus('${d.id}', this.checked)">
      Imprim√©
    </label>
  `;
}

// ========================
// PROJET COMPLET
// ========================
function loadProject() {
  const current = document.querySelector("#detail b:nth-child(2)").innerText;
  const rows = allProjects.filter(p => p.projet == current);

  let html = "<tr><th>ID</th><th>Intitul√©</th><th>Qt√©</th><th>Imprim√©</th></tr>";
  rows.forEach(r => {
    html += `
      <tr>
        <td>${r.id}</td>
        <td>${r.intitule}</td>
        <td>${r.quantite}</td>
        <td>
          <input type="checkbox" ${r.imprime ? "checked" : ""}
            onchange="updateStatus('${r.id}', this.checked)">
        </td>
      </tr>`;
  });

  document.getElementById("projectTable").innerHTML = html;
  document.getElementById("projectBox").style.display = "block";
}

// ========================
// UPDATE STATUS
// ========================
function updateStatus(id, done) {
  fetch(API_URL, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ action:"status", id, done })
  });
}

// ========================
// LOG SCAN
// ========================
function logScan(code) {
  fetch(API_URL, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ action:"scan", code })
  });
}

// ========================
// STOCK
// ========================
fetch(API_URL + "?action=stock")
.then(r => r.json())
.then(data => {
  let html = "<tr><th>R√©f</th><th>Mati√®re</th><th>Stock</th></tr>";
  data.forEach(s => {
    html += `<tr><td>${s.ref}</td><td>${s.matiere}</td><td>${s.stock}</td></tr>`;
  });
  document.getElementById("stockTable").innerHTML = html;
});
</script>

</body>
</html>
